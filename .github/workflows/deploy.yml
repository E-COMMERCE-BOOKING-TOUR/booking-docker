name: CD Deploy

on:
  repository_dispatch:
    types: [update-service]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to update (optional)'
        required: false
        default: 'all'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
              echo "${{ secrets.PAT_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            fi
            cd ${{ secrets.SSH_PATH }}
            git pull origin master
            
            if [ "${{ github.event.client_payload.service }}" != "" ]; then
              echo "Updating specific service: ${{ github.event.client_payload.service }}"
              docker compose -f docker-compose.prod.yml pull ${{ github.event.client_payload.service }}
              docker compose -f docker-compose.prod.yml up -d --remove-orphans ${{ github.event.client_payload.service }}
            else
              echo "Updating all services"
              docker compose -f docker-compose.prod.yml pull
              docker compose -f docker-compose.prod.yml up -d --remove-orphans
            fi
            
            docker image prune -f
